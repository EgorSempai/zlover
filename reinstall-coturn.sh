#!/bin/bash

echo "ðŸ”„ ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Coturn"
echo "=============================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° root
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root: sudo ./reinstall-coturn.sh"
    exit 1
fi

echo "ðŸ“‹ Ð¨Ð°Ð³ 1: ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Coturn..."

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ»ÑƒÐ¶Ð±Ñƒ
systemctl stop coturn 2>/dev/null
systemctl disable coturn 2>/dev/null

# Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ turnserver
pkill -f turnserver 2>/dev/null

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚
apt-get remove --purge -y coturn

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
rm -rf /etc/coturn
rm -rf /var/lib/coturn
rm -f /var/log/coturn.log
rm -f /etc/default/coturn

echo "âœ… Coturn Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»ÐµÐ½"

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 2: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
apt-get update

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Coturn..."
apt-get install -y coturn

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
mkdir -p /etc/coturn

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
cat > /etc/coturn/turnserver.conf << 'EOF'
# ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Coturn
listening-port=3478
external-ip=185.117.154.193
min-port=49152
max-port=65535
lt-cred-mech
use-auth-secret
static-auth-secret=my_secure_secret_key_2024
realm=zloer
log-file=/var/log/coturn.log
no-cli
pidfile=/var/run/turnserver.pid
EOF

echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 5: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð»Ð¾Ð³ Ñ„Ð°Ð¹Ð»
touch /var/log/coturn.log
chown turnserver:turnserver /var/log/coturn.log 2>/dev/null || chown root:root /var/log/coturn.log

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
chmod 644 /etc/coturn/turnserver.conf

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 6: Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑÐ»ÑƒÐ¶Ð±Ñ‹..."

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ coturn Ð² /etc/default/coturn
echo 'TURNSERVER_ENABLED=1' > /etc/default/coturn

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 7: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
turnserver --check-config -c /etc/coturn/turnserver.conf

if [ $? -eq 0 ]; then
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
    exit 1
fi

echo ""
echo "ðŸ“‹ Ð¨Ð°Ð³ 8: Ð—Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±Ñ‹..."
systemctl enable coturn
systemctl start coturn

# Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾
sleep 3

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
if systemctl is-active --quiet coturn; then
    echo "âœ… Coturn ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
    
    echo ""
    echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
    netstat -tulpn | grep -E "(3478|49152)" | head -5
    
    echo ""
    echo "ðŸŽ¯ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Coturn ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
    echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ: sudo systemctl status coturn"
    echo "ðŸ“‹ ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸: sudo journalctl -u coturn -f"
    
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Coturn"
    echo "ðŸ“‹ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ»ÑƒÐ¶Ð±Ñ‹:"
    systemctl status coturn --no-pager
    echo ""
    echo "ðŸ“‹ Ð›Ð¾Ð³Ð¸:"
    journalctl -u coturn --no-pager -n 10
fi

echo ""
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°..."
ufw allow 3478/udp 2>/dev/null
ufw allow 3478/tcp 2>/dev/null
ufw allow 49152:65535/udp 2>/dev/null

echo "âœ… ÐŸÐ¾Ñ€Ñ‚Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹ Ð² Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ðµ"